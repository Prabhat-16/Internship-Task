<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>VoteSecure â€” Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0f1e;
      --surface:   #111827;
      --surface2:  #1a2235;
      --border:    rgba(255,255,255,0.08);
      --text:      #f1f5f9;
      --muted:     #64748b;
      --primary:   #6366f1;
      --primary2:  #818cf8;
      --accent:    #06b6d4;
      --success:   #10b981;
      --warning:   #f59e0b;
      --danger:    #ef4444;
      --gold:      #f59e0b;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€â”€ Background â”€â”€â”€ */
    .orb {
      position: fixed; border-radius: 50%; filter: blur(100px);
      pointer-events: none; z-index: 0;
    }
    .orb-1 { width: 500px; height: 500px; background: rgba(99,102,241,.12); top: -150px; left: -150px; }
    .orb-2 { width: 400px; height: 400px; background: rgba(6,182,212,.08);  bottom: -100px; right: -100px; }

    /* â”€â”€â”€ Layout â”€â”€â”€ */
    .layout { display: flex; min-height: 100vh; position: relative; z-index: 1; }

    /* â”€â”€â”€ Sidebar â”€â”€â”€ */
    .sidebar {
      width: 240px; background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 24px 16px; position: fixed;
      top: 0; left: 0; height: 100vh;
    }
    .sidebar-brand { display: flex; align-items: center; gap: 10px; padding: 0 8px 28px; }
    .sidebar-brand .icon {
      width: 36px; height: 36px; background: linear-gradient(135deg,var(--primary),var(--accent));
      border-radius: 10px; display:flex; align-items:center; justify-content:center; font-size:18px;
    }
    .sidebar-brand span { font-size: 16px; font-weight: 700; }
    .sidebar-brand small { color: var(--danger); font-size: 10px; font-weight: 600;
      background: rgba(239,68,68,.15); padding: 2px 6px; border-radius: 4px; margin-left:4px; }

    .nav-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase;
      letter-spacing: .08em; padding: 0 8px 8px; margin-top: 8px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500;
      color: var(--muted); transition: all .2s; margin-bottom: 2px; border: none;
      background: transparent; width: 100%; text-align: left;
    }
    .nav-item:hover { background: rgba(255,255,255,.05); color: var(--text); }
    .nav-item.active { background: rgba(99,102,241,.15); color: var(--primary2); }
    .nav-item .ni { font-size: 17px; width: 20px; text-align:center; }

    .sidebar-footer { margin-top: auto; }
    .logout-btn {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(239,68,68,.3);
      background: rgba(239,68,68,.08); color: var(--danger); font-size: 14px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all .2s;
    }
    .logout-btn:hover { background: rgba(239,68,68,.18); }

    /* â”€â”€â”€ Main Content â”€â”€â”€ */
    .main { margin-left: 240px; flex: 1; padding: 0; }

    /* â”€â”€â”€ Top Bar â”€â”€â”€ */
    .topbar {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 16px 32px; display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 100;
    }
    .topbar h2 { font-size: 18px; font-weight: 700; }
    .topbar-right { display: flex; align-items: center; gap: 16px; }
    .admin-badge {
      display: flex; align-items: center; gap: 8px; padding: 6px 14px;
      background: rgba(99,102,241,.12); border: 1px solid rgba(99,102,241,.3);
      border-radius: 20px;
    }
    .admin-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: linear-gradient(135deg,var(--primary),var(--accent));
      display:flex; align-items:center; justify-content:center;
      font-size: 12px; font-weight: 700;
    }
    .admin-name { font-size: 13px; font-weight: 600; }

    /* â”€â”€â”€ Content Area â”€â”€â”€ */
    .content { padding: 32px; }

    /* â”€â”€â”€ Section (tab panel) â”€â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€â”€ Stats Cards â”€â”€â”€ */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 32px;
    }
    .stat-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; position: relative; overflow: hidden;
      transition: transform .2s, box-shadow .2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,.3); }
    .stat-card::after {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      border-radius: 16px 16px 0 0;
    }
    .stat-card.purple::after { background: linear-gradient(90deg,var(--primary),var(--primary2)); }
    .stat-card.cyan::after   { background: linear-gradient(90deg,var(--accent),#3b82f6); }
    .stat-card.green::after  { background: linear-gradient(90deg,var(--success),var(--accent)); }
    .stat-card.gold::after   { background: linear-gradient(90deg,var(--gold),#f97316); }
    .stat-card.rose::after   { background: linear-gradient(90deg,#ec4899,var(--primary)); }

    .stat-icon { font-size: 28px; margin-bottom: 12px; }
    .stat-value { font-size: 32px; font-weight: 800; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: var(--muted); font-weight: 500; }
    .stat-sub { font-size: 12px; color: var(--muted); margin-top: 8px; }

    /* â”€â”€â”€ Cards â”€â”€â”€ */
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden; margin-bottom: 24px;
    }
    .card-header {
      padding: 20px 24px 0; display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 20px;
    }
    .card-title { font-size: 16px; font-weight: 700; }
    .card-body { padding: 0 24px 24px; }

    /* â”€â”€â”€ Chart â”€â”€â”€ */
    .chart-wrap { height: 280px; position: relative; }
    canvas { width: 100% !important; }

    /* â”€â”€â”€ Results Table (vote results) â”€â”€â”€ */
    .results-list { display: flex; flex-direction: column; gap: 14px; }
    .result-row {
      display: flex; align-items: center; gap: 14px;
      background: var(--surface2); border-radius: 12px; padding: 16px;
      transition: background .2s;
    }
    .result-row:hover { background: rgba(255,255,255,.05); }
    .result-rank {
      width: 32px; height: 32px; border-radius: 50%; display: flex; align-items:center;
      justify-content: center; font-weight: 800; font-size: 13px; flex-shrink: 0;
    }
    .result-rank.r1 { background: linear-gradient(135deg,#f59e0b,#f97316); color:#000; }
    .result-rank.r2 { background: #475569; color:#fff; }
    .result-rank.r3 { background: #78350f; color:#fff; }
    .result-rank.rn { background: var(--surface); border:1px solid var(--border); color:var(--muted); }

    .result-info { flex: 1; }
    .result-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .result-party { font-size: 12px; color: var(--muted); }
    .result-bar-wrap { flex: 2; }
    .result-meta { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .bar-track { height: 8px; background: rgba(255,255,255,.06); border-radius: 4px; overflow:hidden; }
    .bar-fill { height: 100%; border-radius: 4px; transition: width 1s cubic-bezier(.4,0,.2,1); width: 0; }
    .result-votes { font-size: 16px; font-weight: 700; min-width: 50px; text-align:right; }

    /* â”€â”€â”€ Users Table â”€â”€â”€ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th {
      padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600;
      color: var(--muted); text-transform: uppercase; letter-spacing: .05em;
      border-bottom: 1px solid var(--border); background: var(--surface2);
    }
    tbody tr { border-bottom: 1px solid rgba(255,255,255,.04); transition: background .15s; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    tbody td { padding: 14px 16px; vertical-align: middle; }
    tbody tr:last-child { border-bottom: none; }

    .user-cell { display: flex; align-items: center; gap: 10px; }
    .u-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg,var(--primary),var(--accent));
      display: flex; align-items:center; justify-content:center;
      font-size: 13px; font-weight: 700; flex-shrink:0;
    }
    .u-name { font-weight: 600; font-size: 14px; }
    .u-email { font-size: 12px; color: var(--muted); }

    .badge {
      display: inline-flex; align-items: center; padding: 3px 10px;
      border-radius: 20px; font-size: 11px; font-weight: 600;
    }
    .badge-admin   { background: rgba(99,102,241,.15); color:var(--primary2); }
    .badge-user    { background: rgba(6,182,212,.1);   color:var(--accent); }
    .badge-voted   { background: rgba(16,185,129,.12); color:var(--success); }
    .badge-pending { background: rgba(100,116,139,.12); color:var(--muted); }

    /* â”€â”€â”€ Candidates Management â”€â”€â”€ */
    .add-form {
      background: var(--surface2); border-radius: 12px; padding: 20px;
      display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;
      margin-bottom: 20px; border: 1px solid var(--border);
    }
    .form-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 160px; }
    .form-group label { font-size: 12px; font-weight: 600; color: var(--muted); }
    .form-input {
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); padding: 10px 14px; font-size: 14px; font-family: inherit;
      outline: none; transition: border-color .2s;
    }
    .form-input:focus { border-color: var(--primary); }

    .btn {
      padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer;
      font-size: 14px; font-weight: 600; font-family: inherit; transition: all .2s;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: linear-gradient(135deg,var(--primary),var(--primary2)); color:#fff; }
    .btn-primary:hover { opacity:.88; transform: translateY(-1px); }
    .btn-danger  { background: rgba(239,68,68,.12); color:var(--danger); border:1px solid rgba(239,68,68,.25); }
    .btn-danger:hover  { background: rgba(239,68,68,.22); }
    .btn-warning { background: rgba(245,158,11,.12); color:var(--gold); border:1px solid rgba(245,158,11,.25); }
    .btn-warning:hover { background: rgba(245,158,11,.22); }
    .btn-sm { padding: 6px 14px; font-size: 12px; border-radius: 8px; }

    .cand-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px; background: var(--surface2); border-radius: 12px;
      margin-bottom: 10px; transition: background .2s; gap: 12px;
    }
    .cand-row:hover { background: rgba(255,255,255,.04); }
    .cand-info { flex: 1; }
    .cand-name { font-weight: 600; margin-bottom: 2px; }
    .cand-party { font-size: 12px; color: var(--muted); }
    .cand-votes {
      font-size: 20px; font-weight: 800; color: var(--primary2);
      min-width: 60px; text-align:center;
    }

    /* â”€â”€â”€ Danger Zone â”€â”€â”€ */
    .danger-zone {
      border: 1px solid rgba(239,68,68,.25); border-radius: 16px; padding: 24px;
      background: rgba(239,68,68,.04);
    }
    .danger-zone h3 { color: var(--danger); margin-bottom: 8px; }
    .danger-zone p  { color: var(--muted); font-size: 14px; margin-bottom: 16px; }

    /* â”€â”€â”€ Toast â”€â”€â”€ */
    .toast {
      position: fixed; bottom: 28px; right: 28px; z-index: 9999;
      padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600;
      max-width: 360px; box-shadow: 0 8px 32px rgba(0,0,0,.5);
      transition: all .3s; opacity: 0; transform: translateY(20px);
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.3); color:var(--success); }
    .toast.error   { background: rgba(239,68,68,.15);  border:1px solid rgba(239,68,68,.3);  color:var(--danger); }
    .toast.info    { background: rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); color:var(--primary2); }

    /* â”€â”€â”€ Confirm Modal â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      backdrop-filter: blur(4px); z-index: 1000;
      display: none; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 20px; padding: 32px; max-width: 420px; width: 90%;
      text-align: center;
    }
    .modal-icon { font-size: 48px; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .modal-msg { color: var(--muted); font-size: 14px; margin-bottom: 24px; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; }

    /* â”€â”€â”€ Empty state â”€â”€â”€ */
    .empty { text-align:center; padding: 40px; color: var(--muted); }
    .empty-icon { font-size: 40px; margin-bottom: 12px; }

    /* â”€â”€â”€ Responsive â”€â”€â”€ */
    @media(max-width:768px) {
      .sidebar { display:none; }
      .main { margin-left: 0; }
      .content { padding:20px; }
    }
  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="layout">
    <!-- â”€â”€ Sidebar â”€â”€ -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="icon">ğŸ—³ï¸</div>
        <div>
          <span>VoteSecure</span>
          <small>ADMIN</small>
        </div>
      </div>

      <div class="nav-label">Overview</div>
      <button class="nav-item active" id="nav-dashboard" onclick="showTab('dashboard')">
        <span class="ni">ğŸ“Š</span> Dashboard
      </button>
      <button class="nav-item" id="nav-results" onclick="showTab('results')">
        <span class="ni">ğŸ†</span> Vote Results
      </button>

      <div class="nav-label" style="margin-top:16px">Management</div>
      <button class="nav-item" id="nav-candidates" onclick="showTab('candidates')">
        <span class="ni">ğŸ‘¤</span> Candidates
      </button>
      <button class="nav-item" id="nav-users" onclick="showTab('users')">
        <span class="ni">ğŸ‘¥</span> Users
      </button>

      <div class="nav-label" style="margin-top:16px">System</div>
      <button class="nav-item" id="nav-settings" onclick="showTab('settings')">
        <span class="ni">âš™ï¸</span> Settings
      </button>

      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
      </div>
    </aside>

    <!-- â”€â”€ Main â”€â”€ -->
    <div class="main">
      <!-- Topbar -->
      <div class="topbar">
        <h2 id="pageTitle">Dashboard</h2>
        <div class="topbar-right">
          <div class="admin-badge">
            <div class="admin-avatar" id="adminAvatar">A</div>
            <span class="admin-name" id="adminName">Admin</span>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="content">

        <!-- â”€â”€â”€ Dashboard Tab â”€â”€â”€ -->
        <div class="tab-panel active" id="tab-dashboard">
          <div class="stats-grid">
            <div class="stat-card purple">
              <div class="stat-icon">ğŸ‘¥</div>
              <div class="stat-value" id="s-users">â€”</div>
              <div class="stat-label">Registered Voters</div>
            </div>
            <div class="stat-card cyan">
              <div class="stat-icon">ğŸ—³ï¸</div>
              <div class="stat-value" id="s-votes">â€”</div>
              <div class="stat-label">Total Votes Cast</div>
            </div>
            <div class="stat-card green">
              <div class="stat-icon">ğŸ“ˆ</div>
              <div class="stat-value" id="s-turnout">â€”</div>
              <div class="stat-label">Voter Turnout</div>
            </div>
            <div class="stat-card gold">
              <div class="stat-icon">ğŸ†</div>
              <div class="stat-value" id="s-leader" style="font-size:18px">â€”</div>
              <div class="stat-label">Current Leader</div>
              <div class="stat-sub" id="s-leader-party">â€”</div>
            </div>
            <div class="stat-card rose">
              <div class="stat-icon">ğŸ¯</div>
              <div class="stat-value" id="s-candidates">â€”</div>
              <div class="stat-label">Candidates</div>
            </div>
          </div>

          <!-- Bar Chart -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ“Š Live Vote Distribution</div>
              <button class="btn btn-primary btn-sm" onclick="loadAll()">â†º Refresh</button>
            </div>
            <div class="card-body">
              <div class="chart-wrap">
                <canvas id="voteChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€â”€ Results Tab â”€â”€â”€ -->
        <div class="tab-panel" id="tab-results">
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ† Election Results â€” Rankings</div>
              <button class="btn btn-primary btn-sm" onclick="loadAll()">â†º Refresh</button>
            </div>
            <div class="card-body">
              <div class="results-list" id="resultsList">
                <div class="empty"><div class="empty-icon">â³</div>Loading resultsâ€¦</div>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€â”€ Candidates Tab â”€â”€â”€ -->
        <div class="tab-panel" id="tab-candidates">
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ‘¤ Manage Candidates</div>
            </div>
            <div class="card-body">
              <div class="add-form">
                <div class="form-group">
                  <label>Candidate Name</label>
                  <input class="form-input" id="newCandName" placeholder="e.g. Ravi Kumar" type="text"/>
                </div>
                <div class="form-group">
                  <label>Party</label>
                  <input class="form-input" id="newCandParty" placeholder="e.g. Unity Party" type="text"/>
                </div>
                <button class="btn btn-primary" onclick="addCandidate()">â• Add Candidate</button>
              </div>
              <div id="candidatesList">
                <div class="empty"><div class="empty-icon">â³</div>Loadingâ€¦</div>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€â”€ Users Tab â”€â”€â”€ -->
        <div class="tab-panel" id="tab-users">
          <div class="card">
            <div class="card-header">
              <div class="card-title">ğŸ‘¥ Registered Users</div>
              <button class="btn btn-primary btn-sm" onclick="loadAll()">â†º Refresh</button>
            </div>
            <div class="card-body">
              <!-- Search -->
              <input class="form-input" id="userSearch" type="text" placeholder="ğŸ”  Search by name or emailâ€¦"
                style="width:100%; margin-bottom:16px;" oninput="filterUsers()"/>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>User</th>
                      <th>Role</th>
                      <th>Vote Status</th>
                    </tr>
                  </thead>
                  <tbody id="usersTable">
                    <tr><td colspan="4" class="empty">Loadingâ€¦</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€â”€ Settings Tab â”€â”€â”€ -->
        <div class="tab-panel" id="tab-settings">
          <div class="danger-zone">
            <h3>âš ï¸ Danger Zone</h3>
            <p>These actions are irreversible. Proceed with caution.</p>
            <button class="btn btn-danger" onclick="confirmReset()">
              ğŸ”„ Reset All Votes
            </button>
          </div>
        </div>

      </div><!-- /content -->
    </div><!-- /main -->
  </div><!-- /layout -->

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
      <div class="modal-icon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">Are you sure?</div>
      <div class="modal-msg" id="modalMsg">This action cannot be undone.</div>
      <div class="modal-actions">
        <button class="btn btn-warning" onclick="closeModal()">Cancel</button>
        <button class="btn btn-danger"  id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // â”€â”€ Guards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const role = localStorage.getItem('userRole');
    if (role !== 'ADMIN') { window.location = 'index.html'; }

    const adminName = localStorage.getItem('userName') || 'Admin';
    const initials  = adminName.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
    document.getElementById('adminName').textContent  = adminName;
    document.getElementById('adminAvatar').textContent = initials;

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allCandidates = [];
    let allUsers      = [];
    let chartInstance = null;

    // â”€â”€ Tab navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tabs  = ['dashboard','results','candidates','users','settings'];
    const titles = { dashboard:'Dashboard', results:'Vote Results',
                     candidates:'Manage Candidates', users:'Users', settings:'Settings' };

    function showTab(name) {
      tabs.forEach(t => {
        document.getElementById('tab-' + t).classList.toggle('active', t === name);
        document.getElementById('nav-' + t)?.classList.toggle('active', t === name);
      });
      document.getElementById('pageTitle').textContent = titles[name] || name;
      if (name === 'dashboard' && chartInstance) {
        setTimeout(() => chartInstance.update(), 50);
      }
    }

    // â”€â”€ Load all data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAll() {
      await Promise.all([loadStats(), loadCandidates(), loadUsers()]);
    }

    // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats');
        const d   = await res.json();
        document.getElementById('s-users').textContent      = d.totalUsers;
        document.getElementById('s-votes').textContent      = d.totalVotes;
        document.getElementById('s-turnout').textContent    = d.voterTurnout + '%';
        document.getElementById('s-leader').textContent     = d.leadingCandidate;
        document.getElementById('s-leader-party').textContent = d.leadingParty;
        document.getElementById('s-candidates').textContent = d.totalCandidates;
      } catch(e) {
        showToast('Failed to load stats.', 'error');
      }
    }

    // â”€â”€ Candidates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadCandidates() {
      try {
        const res = await fetch('/api/candidates');
        allCandidates = await res.json();
        renderChart(allCandidates);
        renderResults(allCandidates);
        renderCandidatesList(allCandidates);
      } catch(e) {
        showToast('Failed to load candidates.', 'error');
      }
    }

    // â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const COLORS = [
      '#6366f1','#06b6d4','#10b981','#f59e0b','#ec4899',
      '#8b5cf6','#3b82f6','#14b8a6','#f97316','#a855f7'
    ];

    function renderChart(data) {
      const ctx = document.getElementById('voteChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(c => c.name),
          datasets: [{
            label: 'Votes',
            data:  data.map(c => c.voteCount || 0),
            backgroundColor: data.map((_,i) => COLORS[i % COLORS.length] + 'cc'),
            borderColor:     data.map((_,i) => COLORS[i % COLORS.length]),
            borderWidth: 2, borderRadius: 8, borderSkipped: false,
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false },
            tooltip: { callbacks: { label: ctx => ` ${ctx.raw} votes` } }
          },
          scales: {
            x: { ticks: { color: '#94a3b8', font:{size:12} }, grid: { display:false } },
            y: { ticks: { color: '#94a3b8', font:{size:12}, stepSize:1 },
                 grid:  { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
          }
        }
      });
    }

    // â”€â”€ Results list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderResults(data) {
      const sorted  = [...data].sort((a,b) => (b.voteCount||0) - (a.voteCount||0));
      const total   = sorted.reduce((s,c) => s + (c.voteCount||0), 0);
      const list    = document.getElementById('resultsList');

      if (sorted.length === 0) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ—³ï¸</div>No candidates yet.</div>';
        return;
      }
      list.innerHTML = sorted.map((c, i) => {
        const pct  = total > 0 ? Math.round(((c.voteCount||0) / total) * 100) : 0;
        const rank = i === 0 ? 'r1' : i === 1 ? 'r2' : i === 2 ? 'r3' : 'rn';
        const color = COLORS[i % COLORS.length];
        return `
        <div class="result-row">
          <div class="result-rank ${rank}">${i+1}</div>
          <div class="result-info">
            <div class="result-name">${c.name}</div>
            <div class="result-party">${c.party}</div>
          </div>
          <div class="result-bar-wrap">
            <div class="result-meta"><span>${pct}%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="rf-${c.id}" style="background:${color}"></div>
            </div>
          </div>
          <div class="result-votes">${(c.voteCount||0).toLocaleString()}</div>
        </div>`;
      }).join('');

      // Animate bars
      requestAnimationFrame(() => {
        sorted.forEach(c => {
          const pct  = total > 0 ? Math.round(((c.voteCount||0)/total)*100) : 0;
          const bar  = document.getElementById('rf-' + c.id);
          if (bar) setTimeout(() => { bar.style.width = pct + '%'; }, 80);
        });
      });
    }

    // â”€â”€ Candidates management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCandidatesList(data) {
      const sorted = [...data].sort((a,b) => (b.voteCount||0)-(a.voteCount||0));
      const el = document.getElementById('candidatesList');
      if (sorted.length === 0) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘¤</div>No candidates yet. Add one above.</div>';
        return;
      }
      el.innerHTML = sorted.map(c => `
        <div class="cand-row" id="cand-row-${c.id}">
          <div class="cand-info">
            <div class="cand-name">${c.name}</div>
            <div class="cand-party">${c.party}</div>
          </div>
          <div class="cand-votes">${(c.voteCount||0)} <small style="font-size:11px;font-weight:400;color:var(--muted)">votes</small></div>
          <button class="btn btn-danger btn-sm" onclick="confirmDeleteCandidate(${c.id}, '${c.name.replace(/'/g,"\\'")}')">
            ğŸ—‘ï¸ Delete
          </button>
        </div>`).join('');
    }

    async function addCandidate() {
      const name  = document.getElementById('newCandName').value.trim();
      const party = document.getElementById('newCandParty').value.trim();
      if (!name || !party) { showToast('Please enter both name and party.', 'error'); return; }
      try {
        const res = await fetch('/api/admin/candidates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, party })
        });
        const d = await res.json();
        if (!res.ok) { showToast(d.message || 'Failed to add candidate.', 'error'); return; }
        document.getElementById('newCandName').value  = '';
        document.getElementById('newCandParty').value = '';
        showToast('âœ… Candidate added successfully!', 'success');
        loadAll();
      } catch(e) {
        showToast('Network error.', 'error');
      }
    }

    function confirmDeleteCandidate(id, name) {
      openModal(
        'ğŸ—‘ï¸ Delete Candidate',
        `Are you sure you want to delete <strong>${name}</strong>? This cannot be undone.`,
        () => deleteCandidate(id)
      );
    }

    async function deleteCandidate(id) {
      closeModal();
      try {
        const res = await fetch('/api/admin/candidates/' + id, { method: 'DELETE' });
        const d   = await res.json();
        if (!res.ok) { showToast(d.message || 'Failed to delete.', 'error'); return; }
        showToast('âœ… Candidate deleted.', 'success');
        loadAll();
      } catch(e) {
        showToast('Network error.', 'error');
      }
    }

    // â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadUsers() {
      try {
        const res = await fetch('/api/admin/users');
        allUsers  = await res.json();
        renderUsers(allUsers);
      } catch(e) {
        showToast('Failed to load users.', 'error');
      }
    }

    function renderUsers(list) {
      const tbody = document.getElementById('usersTable');
      if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No users found.</td></tr>';
        return;
      }
      tbody.innerHTML = list.map((u, i) => {
        const av = (u.name||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        return `
        <tr>
          <td style="color:var(--muted);font-size:13px">${i+1}</td>
          <td>
            <div class="user-cell">
              <div class="u-avatar">${av}</div>
              <div>
                <div class="u-name">${u.name}</div>
                <div class="u-email">${u.email}</div>
              </div>
            </div>
          </td>
          <td>
            <span class="badge ${u.role === 'ADMIN' ? 'badge-admin' : 'badge-user'}">
              ${u.role}
            </span>
          </td>
          <td>
            <span class="badge ${u.hasVoted ? 'badge-voted' : 'badge-pending'}">
              ${u.hasVoted ? 'âœ… Voted' : 'â³ Pending'}
            </span>
          </td>
        </tr>`;
      }).join('');
    }

    function filterUsers() {
      const q = document.getElementById('userSearch').value.toLowerCase();
      renderUsers(allUsers.filter(u =>
        (u.name||'').toLowerCase().includes(q) ||
        (u.email||'').toLowerCase().includes(q)
      ));
    }

    // â”€â”€ Reset votes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function confirmReset() {
      openModal(
        'âš ï¸ Reset All Votes',
        'This will clear ALL vote counts and allow all users to vote again. This CANNOT be undone.',
        doReset
      );
    }

    async function doReset() {
      closeModal();
      try {
        const res = await fetch('/api/admin/reset', { method: 'POST' });
        const d   = await res.json();
        showToast('âœ… ' + (d.message || 'Votes reset.'), 'success');
        loadAll();
      } catch(e) {
        showToast('Network error.', 'error');
      }
    }

    // â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _modalCallback = null;
    function openModal(title, msg, callback) {
      document.getElementById('modalTitle').innerHTML = title;
      document.getElementById('modalMsg').innerHTML   = msg;
      _modalCallback = callback;
      document.getElementById('confirmModal').classList.add('open');
    }
    function closeModal() {
      document.getElementById('confirmModal').classList.remove('open');
      _modalCallback = null;
    }
    document.getElementById('modalConfirmBtn').onclick = () => {
      if (_modalCallback) _modalCallback();
    };
    document.getElementById('confirmModal').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeModal();
    });

    // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type='info') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className   = 'toast ' + type + ' show';
      clearTimeout(t._t);
      t._t = setTimeout(() => t.classList.remove('show'), 4000);
    }

    // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function logout() {
      localStorage.clear();
      window.location = 'index.html';
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadAll();
    // Auto-refresh every 30 seconds
    setInterval(loadAll, 30000);
  </script>
</body>
</html>
